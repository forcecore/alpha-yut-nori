var J=Object.defineProperty;var Z=(S,t,e)=>t in S?J(S,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):S[t]=e;var h=(S,t,e)=>Z(S,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const f=class f{getNextPosition(t,e,i=!1){var n;if(e===0)return t;if(e===-1){const a=f.BACK_DO[t];return(a==null?void 0:a[0])??null}const s=((n=f.MOVE_TABLE[t])==null?void 0:n[e])??null;if(s!==null)return s;if(i){const a=f.MOVE_TABLE[t];if(a&&Object.values(a).includes("00"))return"EXIT"}return null}getBackDoDestinations(t){return f.BACK_DO[t]??[]}triggersShortcut(t){return t==="05"||t==="10"}static getEntryPosition(t){return t>=1&&t<=5?String(t).padStart(2,"0"):"01"}static isFinishPosition(t,e){return t==="00"&&e}isValidPosition(t){return f.ALL_POSITIONS.has(t)}};h(f,"NUM_POSITIONS",29),h(f,"START_POSITION","00"),h(f,"GOAL_POSITION","00"),h(f,"OUTER_POSITIONS",Array.from({length:20},(t,e)=>String(e).padStart(2,"0"))),h(f,"RIGHT_DIAGONAL",["aa","bb","cc","pp","qq"]),h(f,"LEFT_DIAGONAL",["xx","yy","cc","uu","vv"]),h(f,"ALL_POSITIONS",new Set([...f.OUTER_POSITIONS,...f.RIGHT_DIAGONAL,...f.LEFT_DIAGONAL])),h(f,"DIAGONAL_CELLS",new Set(["aa","bb","cc","pp","qq","xx","yy","uu","vv"])),h(f,"MOVE_TABLE",{"00":{1:"01",2:"02",3:"03",4:"04",5:"05"},"01":{1:"02",2:"03",3:"04",4:"05",5:"06"},"02":{1:"03",2:"04",3:"05",4:"06",5:"07"},"03":{1:"04",2:"05",3:"06",4:"07",5:"08"},"04":{1:"05",2:"06",3:"07",4:"08",5:"09"},"05":{1:"aa",2:"bb",3:"cc",4:"uu",5:"vv"},"06":{1:"07",2:"08",3:"09",4:"10",5:"11"},"07":{1:"08",2:"09",3:"10",4:"11",5:"12"},"08":{1:"09",2:"10",3:"11",4:"12",5:"13"},"09":{1:"10",2:"11",3:"12",4:"13",5:"14"},10:{1:"xx",2:"yy",3:"cc",4:"pp",5:"qq"},11:{1:"12",2:"13",3:"14",4:"15",5:"16"},12:{1:"13",2:"14",3:"15",4:"16",5:"17"},13:{1:"14",2:"15",3:"16",4:"17",5:"18"},14:{1:"15",2:"16",3:"17",4:"18",5:"19"},15:{1:"16",2:"17",3:"18",4:"19",5:"00"},16:{1:"17",2:"18",3:"19",4:"00"},17:{1:"18",2:"19",3:"00"},18:{1:"19",2:"00"},19:{1:"00"},aa:{1:"bb",2:"cc",3:"uu",4:"vv",5:"15"},bb:{1:"cc",2:"uu",3:"vv",4:"15",5:"16"},cc:{1:"pp",2:"qq",3:"00"},pp:{1:"qq",2:"00"},qq:{1:"00"},xx:{1:"yy",2:"cc",3:"pp",4:"qq",5:"00"},yy:{1:"cc",2:"pp",3:"qq",4:"00"},uu:{1:"vv",2:"15",3:"16",4:"17",5:"18"},vv:{1:"15",2:"16",3:"17",4:"18",5:"19"}}),h(f,"BACK_DO",{"01":["00"],"02":["01"],"03":["02"],"04":["03"],"05":["04"],"06":["05"],"07":["06"],"08":["07"],"09":["08"],10:["09"],11:["10"],12:["11"],13:["12"],14:["13"],15:["14","vv"],16:["15"],17:["16"],18:["17"],19:["18"],"00":["19","qq"],aa:["05"],bb:["aa"],cc:["bb","yy"],uu:["cc"],vv:["uu"],xx:["10"],yy:["xx"],pp:["cc"],qq:["pp"]});let V=f;class j{constructor(t,e){h(this,"pieceId");h(this,"playerId");h(this,"position",null);h(this,"isActive",!1);h(this,"hasMoved",!1);this.pieceId=t,this.playerId=e}enterBoard(t){this.position=t,this.isActive=!0,this.hasMoved=!0}moveTo(t){this.position=t,this.hasMoved=!0}finish(){this.position=null,this.isActive=!1}capture(){this.position=null,this.isActive=!1,this.hasMoved=!1}hasFinished(){return!this.isActive&&this.hasMoved&&this.position===null}clone(){const t=new j(this.pieceId,this.playerId);return t.position=this.position,t.isActive=this.isActive,t.hasMoved=this.hasMoved,t}}const O=class O{constructor(t,e){h(this,"playerId");h(this,"name");h(this,"pieces");this.playerId=t,this.name=e,this.pieces=Array.from({length:O.NUM_PIECES},(i,s)=>new j(s,t))}getActivePieces(){return this.pieces.filter(t=>t.isActive)}getFinishedPieces(){return this.pieces.filter(t=>t.hasFinished())}getInactivePieces(){return this.pieces.filter(t=>!t.isActive&&!t.hasFinished())}hasFinished(){return this.getFinishedPieces().length===O.NUM_PIECES}getStacks(){const t=new Map;for(const e of this.getActivePieces())if(e.position!==null){const i=t.get(e.position);i?i.push(e):t.set(e.position,[e])}return t}getPieceById(t){return this.pieces[t]}canEnterNewPiece(){return this.getInactivePieces().length>0}clone(){const t=new O(this.playerId,this.name);return t.pieces=this.pieces.map(e=>e.clone()),t}};h(O,"NUM_PIECES",4);let K=O;const A=class A{static throw(){const t=Array.from({length:4},()=>Math.random()<A.FLAT_PROBABILITY),e=t.filter(Boolean).length;let i=A.THROW_NAMES[e];return i==="do"&&t.indexOf(!0)===0&&(i="back_do"),{name:i,value:A.MOVE_VALUES[i],sticks:t}}static grantsExtraTurn(t){return A.EXTRA_TURN_THROWS.has(t)}static getMoveValue(t){return A.MOVE_VALUES[t]}};h(A,"THROW_NAMES",{1:"do",2:"gae",3:"geol",4:"yut",0:"mo"}),h(A,"MOVE_VALUES",{do:1,back_do:-1,gae:2,geol:3,yut:4,mo:5}),h(A,"EXTRA_TURN_THROWS",new Set(["yut","mo"])),h(A,"FLAT_PROBABILITY",.6),h(A,"KOREAN_NAMES",{do:"ë„",back_do:"ë¹½ë„",gae:"ê°œ",geol:"ê±¸",yut:"ìœ·",mo:"ëª¨"});let D=A;class z{constructor(t,e=4,i=!1){h(this,"board");h(this,"numPlayers");h(this,"players");h(this,"currentPlayerIdx");h(this,"gameState");h(this,"winner");h(this,"rankings");h(this,"accumulatedMoves");h(this,"moveHistory");h(this,"mustLandExactly");if(e<2||e>6)throw new Error("Number of players must be between 2 and 6");const s=t??Array.from({length:e},(n,a)=>`Player ${a}`);if(s.length!==e)throw new Error(`Must provide exactly ${e} player names`);this.board=new V,this.numPlayers=e,this.players=s.map((n,a)=>new K(a,n)),this.currentPlayerIdx=0,this.gameState="playing",this.winner=null,this.rankings=[],this.accumulatedMoves=[],this.moveHistory=[],this.mustLandExactly=i}getCurrentPlayer(){return this.players[this.currentPlayerIdx]}throwPhase(t=!1){const e=[];for(t||(this.accumulatedMoves=[]);;){const i=D.throw();e.push(i),this.accumulatedMoves.push(i.value);const s=t?" (bonus)":"";if(this.logMove(`${this.getCurrentPlayer().name} threw ${i.name} (${i.value} spaces)${s}`),!D.grantsExtraTurn(i.name))break}return e}getLegalMoves(t){const e=this.players[t],i=[];for(const s of e.getActivePieces()){if(s.position==="00"&&s.hasMoved){for(const n of this.accumulatedMoves)if(n===-1)for(const a of this.board.getBackDoDestinations("00"))i.push({pieceId:s.pieceId,steps:n,destination:a});else i.push({pieceId:s.pieceId,steps:n,destination:"EXIT"});continue}for(const n of this.accumulatedMoves)if(n===-1)for(const a of this.board.getBackDoDestinations(s.position))i.push({pieceId:s.pieceId,steps:n,destination:a});else{const a=this.board.getNextPosition(s.position,n,!this.mustLandExactly);a!==null&&i.push({pieceId:s.pieceId,steps:n,destination:a})}}if(e.canEnterNewPiece()&&this.accumulatedMoves.length>0){for(const s of this.accumulatedMoves)if(s>=1&&s<=5){const n=String(s).padStart(2,"0");i.push({pieceId:-1,steps:s,destination:n})}}return i}movePiece(t,e,i,s){const n=this.players[t];if(e===-1){if(!n.canEnterNewPiece())return{success:!1,captured:!1};if(!this.accumulatedMoves.includes(i))return{success:!1,captured:!1};if(i<1||i>5)return{success:!1,captured:!1};const d=String(i).padStart(2,"0"),p=n.getInactivePieces()[0];return p.enterBoard(d),this.removeAccumulatedMove(i),this.board.triggersShortcut(d)?this.logMove(`${n.name} entered new piece (Piece ${p.pieceId}) at position ${d} (shortcut position)`):this.logMove(`${n.name} entered new piece (Piece ${p.pieceId}) at position ${d}`),{success:!0,captured:this.checkCapture(t,p.position)}}const a=n.getPieceById(e);if(!a.isActive)return{success:!1,captured:!1};if(!this.accumulatedMoves.includes(i))return{success:!1,captured:!1};const r=a.position;if(r==="00"&&a.hasMoved&&i!==-1){const d=this.getStackAtPosition(t,r),p=d.length===1?`Piece ${e}`:`Stack (x${d.length})`;for(const g of d)g.finish();return this.removeAccumulatedMove(i),this.logMove(`${n.name}'s ${p} exited the board!`),{success:!0,captured:!1}}let c;if(i===-1&&s){if(!this.board.getBackDoDestinations(r).includes(s))return{success:!1,captured:!1};c=s}else c=this.board.getNextPosition(r,i,!this.mustLandExactly);if(c===null)return{success:!1,captured:!1};if(c==="EXIT"){const d=this.getStackAtPosition(t,r),p=d.length===1?`Piece ${e}`:`Stack (x${d.length})`;for(const g of d)g.finish();return this.removeAccumulatedMove(i),this.logMove(`${n.name}'s ${p} exited the board!`),{success:!0,captured:!1}}const o=this.getStackAtPosition(t,r);for(const d of o)d.moveTo(c);this.removeAccumulatedMove(i);const l=o.length===1?`Piece ${e}`:`Stack (x${o.length})`;return c==="00"?this.logMove(`${n.name} moved ${l} ${i} spaces to position 00 (at goal - next move exits)`):this.board.triggersShortcut(c)?this.logMove(`${n.name} moved ${l} ${i} spaces to ${c} (shortcut position - next move uses diagonal)`):this.logMove(`${n.name} moved ${l} ${i} spaces to ${c}`),{success:!0,captured:this.checkCapture(t,c)}}getStackAtPosition(t,e){return this.players[t].getActivePieces().filter(s=>s.position===e)}checkCapture(t,e){let i=!1;for(const s of this.players){if(s.playerId===t)continue;const n=s.getActivePieces().filter(a=>a.position===e);if(n.length>0){i=!0;for(const a of n)a.capture(),this.logMove(`${this.players[t].name} captured ${s.name}'s Piece ${a.pieceId}!`)}}return i}checkWinCondition(){let t=!1;for(const i of this.players)if(i.hasFinished()&&!this.rankings.includes(i.playerId)){this.rankings.push(i.playerId);const s=this.rankings.length;this.logMove(`${i.name} finishes in place #${s}!`),this.winner===null&&(this.winner=i.playerId),t=!0}const e=this.players.filter(i=>!this.rankings.includes(i.playerId));return e.length<=1?(e.length===1&&this.rankings.push(e[0].playerId),this.gameState="finished",!0):t}nextTurn(){for(let t=0;t<this.numPlayers&&(this.currentPlayerIdx=(this.currentPlayerIdx+1)%this.numPlayers,!!this.rankings.includes(this.currentPlayerIdx));t++);this.accumulatedMoves=[]}logMove(t){this.moveHistory.push(t)}getGameState(){return{currentPlayer:this.currentPlayerIdx,gameState:this.gameState,winner:this.winner,rankings:[...this.rankings],accumulatedMoves:[...this.accumulatedMoves],players:this.players.map(t=>({id:t.playerId,name:t.name,activePieces:t.getActivePieces().length,finishedPieces:t.getFinishedPieces().length,pieces:t.pieces.map(e=>({id:e.pieceId,position:e.position,isActive:e.isActive,hasMoved:e.hasMoved}))})),moveHistory:this.moveHistory.slice(-10)}}getAllPieces(){return this.players.flatMap(t=>t.pieces)}clone(){const t=Object.create(z.prototype);return t.board=this.board,t.numPlayers=this.numPlayers,t.players=this.players.map(e=>e.clone()),t.currentPlayerIdx=this.currentPlayerIdx,t.gameState=this.gameState,t.winner=this.winner,t.rankings=[...this.rankings],t.accumulatedMoves=[...this.accumulatedMoves],t.moveHistory=[],t.mustLandExactly=this.mustLandExactly,t}removeAccumulatedMove(t){const e=this.accumulatedMoves.indexOf(t);e!==-1&&this.accumulatedMoves.splice(e,1)}}const tt=3,M=600,C=60,x={x:C,y:C},P={x:M-C,y:C},E={x:M-C,y:M-C},L={x:C,y:M-C},k={x:M/2,y:M/2};function y(S,t,e){return{x:S.x+(t.x-S.x)*e,y:S.y+(t.y-S.y)*e}}const $={"00":E,"01":y(E,P,1/5),"02":y(E,P,2/5),"03":y(E,P,3/5),"04":y(E,P,4/5),"05":P,"06":y(P,x,1/5),"07":y(P,x,2/5),"08":y(P,x,3/5),"09":y(P,x,4/5),10:x,11:y(x,L,1/5),12:y(x,L,2/5),13:y(x,L,3/5),14:y(x,L,4/5),15:L,16:y(L,E,1/5),17:y(L,E,2/5),18:y(L,E,3/5),19:y(L,E,4/5),aa:y(P,k,1/3),bb:y(P,k,2/3),cc:k,uu:y(k,L,1/3),vv:y(k,L,2/3),xx:y(x,k,1/3),yy:y(x,k,2/3),pp:y(k,E,1/3),qq:y(k,E,2/3)},et=[["00","01"],["01","02"],["02","03"],["03","04"],["04","05"],["05","06"],["06","07"],["07","08"],["08","09"],["09","10"],["10","11"],["11","12"],["12","13"],["13","14"],["14","15"],["15","16"],["16","17"],["17","18"],["18","19"],["19","00"],["05","aa"],["aa","bb"],["bb","cc"],["cc","uu"],["uu","vv"],["vv","15"],["10","xx"],["xx","yy"],["yy","cc"],["cc","pp"],["pp","qq"],["qq","00"]],st=new Set(["00","05","10","15","cc"]),it=16,T=22,U=13,B=["#e74c3c","#3498db","#2ecc71","#f1c40f"],H=["Q","W","E","R"],nt=["Satoshi Nakamoto BTC","Vitalik Buterin ETH","Markus-Palmer DOGE","Sam Altman WLD"],at=[{x:M-20,y:M-20,stackDir:-1},{x:M-20,y:20,stackDir:1},{x:20,y:20,stackDir:1},{x:20,y:M-20,stackDir:-1}],m="http://www.w3.org/2000/svg";class rt{constructor(t){h(this,"svg");h(this,"staticLayer");h(this,"pieceLayer");h(this,"highlightLayer");h(this,"onPieceClickCb",null);h(this,"onPositionClickCb",null);h(this,"onNewPieceClickCb",null);this.svg=t,this.staticLayer=this.createGroup("static-layer"),this.highlightLayer=this.createGroup("highlight-layer"),this.pieceLayer=this.createGroup("piece-layer"),this.svg.appendChild(this.staticLayer),this.svg.appendChild(this.highlightLayer),this.svg.appendChild(this.pieceLayer),this.drawStaticBoard()}createGroup(t){const e=document.createElementNS(m,"g");return e.id=t,e}drawStaticBoard(){for(const[i,s]of et){const n=$[i],a=$[s],r=document.createElementNS(m,"line");r.setAttribute("x1",String(n.x)),r.setAttribute("y1",String(n.y)),r.setAttribute("x2",String(a.x)),r.setAttribute("y2",String(a.y)),r.classList.add("board-line"),this.staticLayer.appendChild(r)}for(const[i,s]of Object.entries($)){const n=st.has(i),a=n?T:it,r=document.createElementNS(m,"circle");r.setAttribute("cx",String(s.x)),r.setAttribute("cy",String(s.y)),r.setAttribute("r",String(a)),r.classList.add("board-node"),n&&r.classList.add("corner"),r.dataset.position=i,r.addEventListener("click",()=>{var o;(o=this.onPositionClickCb)==null||o.call(this,i)}),this.staticLayer.appendChild(r);const c=document.createElementNS(m,"text");c.setAttribute("x",String(s.x)),c.setAttribute("y",String(s.y+a+12)),c.classList.add("board-label"),c.textContent=i,this.staticLayer.appendChild(c)}const t=$["00"],e=document.createElementNS(m,"text");e.setAttribute("x",String(t.x)),e.setAttribute("y",String(t.y)),e.classList.add("board-label"),e.style.fontSize="9px",e.style.fill="#aaa",e.textContent="START",this.staticLayer.appendChild(e)}updatePieces(t,e,i){for(;this.pieceLayer.firstChild;)this.pieceLayer.removeChild(this.pieceLayer.firstChild);e&&this.drawReserves(e,i);const s=new Map;for(const n of t){if(!n.isActive||n.position===null)continue;const a=n.position;s.has(a)||s.set(a,[]);const r=s.get(a);let c=r.find(o=>o.playerId===n.playerId);c||(c={playerId:n.playerId,pieces:[],position:n.position},r.push(c)),c.pieces.push(n)}for(const[n,a]of s){const r=$[n];if(!r)continue;const c=a.length;a.forEach((o,l)=>{const u=c>1?(l-(c-1)/2)*28:0,d=o.pieces.length,p=-8;for(let g=0;g<d;g++){const v=o.pieces[g],G=r.x+u,N=r.y+g*p,b=document.createElementNS(m,"g");b.classList.add("piece-group"),b.style.transform=`translate(${G}px, ${N}px)`,b.dataset.playerId=String(o.playerId),b.dataset.pieceId=String(v.pieceId),b.dataset.position=n,b.addEventListener("click",I=>{var Y;I.stopPropagation(),(Y=this.onPieceClickCb)==null||Y.call(this,o.playerId,o.pieces[0].pieceId)});const w=document.createElementNS(m,"circle");if(w.setAttribute("cx","0"),w.setAttribute("cy","0"),w.setAttribute("r",String(U)),w.classList.add("piece-circle"),w.style.fill=B[o.playerId]??"#888",b.appendChild(w),g===d-1&&o.playerId===i){const I=document.createElementNS(m,"text");I.setAttribute("x","0"),I.setAttribute("y","0"),I.classList.add("piece-label"),I.textContent=H[v.pieceId]??String(v.pieceId),b.appendChild(I)}this.pieceLayer.appendChild(b)}})}}drawReserves(t,e){for(const n of t){const a=n.getInactivePieces();if(a.length===0)continue;const r=at[n.playerId];if(r)for(let c=0;c<a.length;c++){const o=a[c],l=r.x,u=r.y+c*8*r.stackDir,d=document.createElementNS(m,"g");d.classList.add("piece-group","reserve-piece"),d.style.transform=`translate(${l}px, ${u}px)`,d.dataset.playerId=String(n.playerId),d.dataset.pieceId=String(o.pieceId),d.dataset.reserve="true",d.addEventListener("click",g=>{var v;g.stopPropagation(),(v=this.onNewPieceClickCb)==null||v.call(this)});const p=document.createElementNS(m,"circle");if(p.setAttribute("cx","0"),p.setAttribute("cy","0"),p.setAttribute("r",String(11)),p.classList.add("piece-circle"),p.style.fill=B[n.playerId]??"#888",p.style.opacity="0.6",d.appendChild(p),c===a.length-1&&n.playerId===e){const g=document.createElementNS(m,"text");g.setAttribute("x","0"),g.setAttribute("y","0"),g.classList.add("piece-label"),g.style.opacity="0.8",g.textContent="N",d.appendChild(g)}this.pieceLayer.appendChild(d)}}}highlightPieces(t,e,i){this.clearHighlights();const s=this.pieceLayer.querySelectorAll(".piece-group");for(const n of s){const a=n,r=Number(a.dataset.playerId),c=Number(a.dataset.pieceId);if(r===t&&e.has(c)){const o=document.createElementNS(m,"circle");o.setAttribute("cx","0"),o.setAttribute("cy","0"),o.setAttribute("r",String(U+5)),o.classList.add("highlight-ring"),a.insertBefore(o,a.firstChild)}}}selectPiece(t,e){const i=this.pieceLayer.querySelectorAll(".piece-group");for(const s of i){const n=s;if(Number(n.dataset.playerId)===t&&Number(n.dataset.pieceId)===e){const a=U+6,r=6,c=document.createElementNS(m,"path");c.setAttribute("d",[`M${-a},${-a+r} L${-a},${-a} L${-a+r},${-a}`,`M${a-r},${-a} L${a},${-a} L${a},${-a+r}`,`M${a},${a-r} L${a},${a} L${a-r},${a}`,`M${-a+r},${a} L${-a},${a} L${-a},${a-r}`].join(" ")),c.classList.add("selection-bracket"),n.appendChild(c);break}}}highlightDestinations(t){this.svg.appendChild(this.highlightLayer);for(const[e,i]of t){if(e==="EXIT"){this.drawExitArrow(i);continue}const s=$[e];if(!s)continue;const n=document.createElementNS(m,"g");n.style.cursor="pointer",n.addEventListener("click",()=>{var r;(r=this.onPositionClickCb)==null||r.call(this,e)});const a=document.createElementNS(m,"circle");if(a.setAttribute("cx",String(s.x)),a.setAttribute("cy",String(s.y)),a.setAttribute("r",String(T)),a.classList.add("dest-highlight"),a.dataset.destPosition=e,n.appendChild(a),i){const r=document.createElementNS(m,"text");r.setAttribute("x",String(s.x+T+8)),r.setAttribute("y",String(s.y)),r.classList.add("dest-key-label"),r.textContent=i,n.appendChild(r)}this.highlightLayer.appendChild(n)}}drawExitArrow(t){const e=$["00"],i=e.x,s=e.y,n=document.createElementNS(m,"g");n.classList.add("exit-indicator"),n.style.cursor="pointer",n.addEventListener("click",()=>{var u;(u=this.onPositionClickCb)==null||u.call(this,"EXIT")});const a=document.createElementNS(m,"g");a.classList.add("exit-rays-group"),a.style.transformOrigin=`${i}px ${s}px`;const r=8,c=T+6,o=T+22;for(let u=0;u<r;u++){const d=u/r*Math.PI*2,p=document.createElementNS(m,"line");p.setAttribute("x1",String(i+Math.cos(d)*c)),p.setAttribute("y1",String(s+Math.sin(d)*c)),p.setAttribute("x2",String(i+Math.cos(d)*o)),p.setAttribute("y2",String(s+Math.sin(d)*o)),p.classList.add("exit-ray"),a.appendChild(p)}n.appendChild(a);const l=document.createElementNS(m,"text");l.setAttribute("x",String(i)),l.setAttribute("y",String(s-T-26)),l.classList.add("dest-key-label"),l.style.textAnchor="middle",l.textContent=t?`[${t}] EXIT`:"EXIT",n.appendChild(l),this.highlightLayer.appendChild(n)}clearHighlights(){for(;this.highlightLayer.firstChild;)this.highlightLayer.removeChild(this.highlightLayer.firstChild);this.svg.insertBefore(this.highlightLayer,this.pieceLayer);for(const t of this.pieceLayer.querySelectorAll(".highlight-ring, .selection-bracket"))t.remove()}showCaptureEffect(){const i=document.createElementNS(m,"g");i.classList.add("capture-effect");const s=12;for(let c=0;c<s;c++){const o=c/s*Math.PI*2,l=document.createElementNS(m,"line");l.setAttribute("x1",String(300)),l.setAttribute("y1",String(300)),l.setAttribute("x2",String(300+Math.cos(o)*120)),l.setAttribute("y2",String(300+Math.sin(o)*120)),l.classList.add("capture-ray"),i.appendChild(l)}const n=document.createElementNS(m,"circle");n.setAttribute("cx",String(300)),n.setAttribute("cy",String(300)),n.setAttribute("r","60"),n.classList.add("capture-glow"),i.appendChild(n);const a=document.createElementNS(m,"text");a.setAttribute("x",String(300)),a.setAttribute("y",String(292)),a.classList.add("capture-text"),a.textContent="CAPTURE!",i.appendChild(a);const r=document.createElementNS(m,"text");return r.setAttribute("x",String(300)),r.setAttribute("y",String(320)),r.classList.add("capture-subtext"),r.textContent="BONUS THROW",i.appendChild(r),this.svg.appendChild(i),new Promise(c=>{setTimeout(()=>{i.remove(),c()},1200)})}showGameOverEffect(t){const s=document.createElementNS(m,"g");s.classList.add("gameover-effect");const n=document.createElementNS(m,"rect");n.setAttribute("x","0"),n.setAttribute("y","0"),n.setAttribute("width","600"),n.setAttribute("height","600"),n.classList.add("gameover-backdrop"),s.appendChild(n);const a=16;for(let o=0;o<a;o++){const l=o/a*Math.PI*2,u=document.createElementNS(m,"line");u.setAttribute("x1",String(300)),u.setAttribute("y1",String(270)),u.setAttribute("x2",String(300+Math.cos(l)*200)),u.setAttribute("y2",String(270+Math.sin(l)*200)),u.classList.add("gameover-ray"),s.appendChild(u)}const r=document.createElementNS(m,"text");r.setAttribute("x",String(300)),r.setAttribute("y",String(200)),r.classList.add("gameover-title"),r.textContent="GAME OVER",s.appendChild(r);const c=["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"];for(let o=0;o<t.length;o++){const l=t[o],d=o===t.length-1?"":c[o]??"",p=260+o*42,g=document.createElementNS(m,"text");g.setAttribute("x",String(300)),g.setAttribute("y",String(p)),g.classList.add("gameover-rank"),g.style.fill=l.color,g.style.animationDelay=`${.3+o*.2}s`,g.textContent=`#${o+1}  ${d} ${l.name}`,s.appendChild(g)}this.svg.appendChild(s)}onPieceClick(t){this.onPieceClickCb=t}onPositionClick(t){this.onPositionClickCb=t}onNewPieceClick(t){this.onNewPieceClickCb=t}triggerNewPieceClick(){var t;(t=this.onNewPieceClickCb)==null||t.call(this)}}const R="http://www.w3.org/2000/svg";class ct{constructor(){h(this,"throwArea");h(this,"throwSvg");h(this,"throwResult");this.throwArea=document.getElementById("throw-area"),this.throwSvg=document.getElementById("throw-svg"),this.throwResult=document.getElementById("throw-result")}async animate(t){for(this.throwArea.classList.remove("hidden"),this.throwResult.textContent="";this.throwSvg.firstChild;)this.throwSvg.removeChild(this.throwSvg.firstChild);const e=20,i=70,s=50,n=(300-(4*e+3*s))/2;for(let c=0;c<4;c++){const o=n+c*(e+s),l=25,u=t.sticks[c],d=document.createElementNS(R,"g");d.style.animationDelay=`${c*.1}s`,d.classList.add("stick-tumbling");const p=document.createElementNS(R,"rect");if(p.setAttribute("x",String(o)),p.setAttribute("y",String(l)),p.setAttribute("width",String(e)),p.setAttribute("height",String(i)),p.classList.add("yut-stick"),p.classList.add(u?"flat":"round"),d.appendChild(p),!u){const g=o+e/2,v=4,G=[l+17,l+35,l+53];for(const N of G){const b=document.createElementNS(R,"g");b.classList.add("stick-x-mark");const w=document.createElementNS(R,"line");w.setAttribute("x1",String(g-v)),w.setAttribute("y1",String(N-v)),w.setAttribute("x2",String(g+v)),w.setAttribute("y2",String(N+v));const I=document.createElementNS(R,"line");I.setAttribute("x1",String(g+v)),I.setAttribute("y1",String(N-v)),I.setAttribute("x2",String(g-v)),I.setAttribute("y2",String(N+v)),b.appendChild(w),b.appendChild(I),d.appendChild(b)}}this.throwSvg.appendChild(d)}await new Promise(c=>setTimeout(c,600));const a=D.KOREAN_NAMES[t.name],r=t.value>=4?"#ffeb3b":t.value===-1?"#e74c3c":"#fff";this.throwResult.innerHTML=`<span style="color:${r}">${t.name} ${a} (${t.value>0?"+":""}${t.value})</span>`,await new Promise(c=>setTimeout(c,800))}hide(){this.throwArea.classList.add("hidden")}}class F{constructor(){h(this,"resolveMove",null)}chooseMove(t,e){return new Promise(i=>{this.resolveMove=i})}submitMove(t,e,i){var s;(s=this.resolveMove)==null||s.call(this,{pieceId:t,steps:e,destination:i}),this.resolveMove=null}submitSkip(){var t;(t=this.resolveMove)==null||t.call(this,null),this.resolveMove=null}}class ot{async chooseMove(t,e){const i=e[Math.floor(Math.random()*e.length)];return{pieceId:i.pieceId,steps:i.steps,destination:i.destination}}}const _=class _{constructor(t,e,i=100){h(this,"game");h(this,"playerId");h(this,"numSimulations");this.game=t,this.playerId=e,this.numSimulations=i}async chooseMove(t,e){const i=new Map;for(const r of e){let c;r.pieceId===-1?c=`entry:${r.steps}:${r.destination}`:c=`${this.game.players[this.playerId].getPieceById(r.pieceId).position}:${r.steps}:${r.destination}`,i.has(c)||i.set(c,r)}const s=[...i.values()];if(s.length===1){const r=s[0];return{pieceId:r.pieceId,steps:r.steps,destination:r.destination}}const n=[];for(const r of s){let c=0;for(let o=0;o<this.numSimulations;o++)c+=this.simulate(r.pieceId,r.steps,r.destination);n.push({move:r,winRate:c/this.numSimulations})}n.sort((r,c)=>c.winRate-r.winRate),console.log(`[MC] Evaluating ${n.length} moves (${this.numSimulations} sims each):`);for(const{move:r,winRate:c}of n){const o=r===n[0].move?" <<":"";console.log(`  piece=${r.pieceId} steps=${r.steps} dest=${r.destination}: ${(c*100).toFixed(1)}%${o}`)}const a=n[0].move;return{pieceId:a.pieceId,steps:a.steps,destination:a.destination}}simulate(t,e,i){const s=this.game.clone(),n=this.playerId,a=s.rankings.length,{success:r,captured:c}=s.movePiece(n,t,e,i);if(!r)return 0;if(c&&s.throwPhase(!0),s.checkWinCondition(),s.rankings.length>a||(this.playRemainingMoves(s,n),s.rankings.length>a))return s.rankings[a]===n?1:0;if(s.gameState!=="playing")return 0;s.nextTurn();for(let o=0;o<_.MAX_ROLLOUT_TURNS&&s.gameState==="playing";o++){const l=s.currentPlayerIdx;if(s.throwPhase(),this.playRemainingMoves(s,l),s.rankings.length>a)return s.rankings[a]===n?1:0;s.nextTurn()}return s.rankings.length>a?s.rankings[a]===n?1:0:this.heuristicScore(s)}playRemainingMoves(t,e){for(;t.accumulatedMoves.length>0;){const i=t.getLegalMoves(e);if(i.length===0){t.accumulatedMoves=[];break}const s=i[Math.floor(Math.random()*i.length)],{success:n,captured:a}=t.movePiece(e,s.pieceId,s.steps,s.destination);if(!n){t.accumulatedMoves=[];break}if(a&&t.throwPhase(!0),t.checkWinCondition())break}}heuristicScore(t){const e=t.players[this.playerId].getFinishedPieces().length;let i=e/4,s=0;for(const n of t.players)n.playerId!==this.playerId&&(s=Math.max(s,n.getFinishedPieces().length));return e>s&&(i+=.1),i}};h(_,"MAX_ROLLOUT_TURNS",200);let X=_;class Q{constructor(t,e,i=null,s=null){h(this,"game");h(this,"playerId");h(this,"parent");h(this,"children");h(this,"untriedActions");h(this,"action");h(this,"visits");h(this,"wins");this.game=t,this.playerId=e,this.parent=i,this.children=[],this.action=s,this.visits=0,this.wins=0,this.untriedActions=null}getUntriedActions(){if(this.untriedActions!==null)return this.untriedActions;if(this.game.accumulatedMoves.length===0)return this.untriedActions=[],this.untriedActions;const t=this.game.getLegalMoves(this.playerId);if(t.length===0)return this.untriedActions=[],this.untriedActions;const e=new Map;for(const a of t){let r;a.pieceId===-1?r=`entry:${a.steps}:${a.destination}`:r=`${this.game.players[this.playerId].getPieceById(a.pieceId).position}:${a.steps}:${a.destination}`,e.has(r)||e.set(r,a)}const i=[...e.values()].map(a=>({pieceId:a.pieceId,steps:a.steps,destination:a.destination})),s=new Set(["xx","yy","cc","pp","qq","15","16","17","18","19"]);return this.game.players[this.playerId].getActivePieces().some(a=>s.has(a.position))&&i.push(null),this.untriedActions=i,this.untriedActions}isTerminal(){return this.game.accumulatedMoves.length===0||this.game.gameState!=="playing"||this.game.checkWinCondition()}ucb1(t=1.414){return this.visits===0?1/0:this.wins/this.visits+t*Math.sqrt(Math.log(this.parent.visits)/this.visits)}bestChild(){let t=this.children[0],e=t.ucb1();for(let i=1;i<this.children.length;i++){const s=this.children[i].ucb1();s>e&&(e=s,t=this.children[i])}return t}mostVisitedChild(){let t=this.children[0];for(let e=1;e<this.children.length;e++)this.children[e].visits>t.visits&&(t=this.children[e]);return t}}const q=class q{constructor(t,e,i=1e3){h(this,"game");h(this,"playerId");h(this,"numIterations");h(this,"reuseRoot",null);this.game=t,this.playerId=e,this.numIterations=i}movesMatch(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}async chooseMove(t,e){const i=new Map;for(const l of e){let u;l.pieceId===-1?u=`entry:${l.steps}:${l.destination}`:u=`${this.game.players[this.playerId].getPieceById(l.pieceId).position}:${l.steps}:${l.destination}`,i.has(u)||i.set(u,l)}const s=[...i.values()];if(s.length===1){this.reuseRoot=null;const l=s[0];return{pieceId:l.pieceId,steps:l.steps,destination:l.destination}}let n=null,a=0;this.reuseRoot!==null&&(this.movesMatch(this.reuseRoot.game.accumulatedMoves,this.game.accumulatedMoves)&&(n=this.reuseRoot,a=n.visits,n.parent=null),this.reuseRoot=null),n===null&&(n=new Q(this.game.clone(),this.playerId));for(let l=0;l<this.numIterations;l++){const u=this.select(n),d=this.expand(u),p=this.simulate(d);this.backpropagate(d,p)}if(n.children.length===0){this.reuseRoot=null;const l=s[0];return{pieceId:l.pieceId,steps:l.steps,destination:l.destination}}const r=n.mostVisitedChild();this.reuseRoot=r.action!==null?r:null;const c=a?` (reused ${a} prior visits)`:"",o=[...n.children].sort((l,u)=>u.visits-l.visits);console.log(`[MCTS] ${this.numIterations} iterations${c}, ${n.children.length} root children:`);for(const l of o){const u=l.visits>0?l.wins/l.visits:0,d=l.action===null?"skip":`piece=${l.action.pieceId} steps=${l.action.steps} dest=${l.action.destination}`,p=l===r?" <<":"";console.log(`  ${d}: ${l.visits} visits, ${(u*100).toFixed(1)}% winrate${p}`)}return r.action}select(t){for(;!t.isTerminal();){if(t.getUntriedActions().length>0||t.children.length===0)return t;t=t.bestChild()}return t}expand(t){const e=t.getUntriedActions();if(e.length===0||t.isTerminal())return t;const i=e.pop(),s=t.game.clone();if(i===null)s.accumulatedMoves=[];else{const{success:a,captured:r}=s.movePiece(this.playerId,i.pieceId,i.steps,i.destination);if(!a)return t;r&&s.throwPhase(!0),s.checkWinCondition()}const n=new Q(s,this.playerId,t,i);return t.children.push(n),n}simulate(t){const e=t.game.clone(),i=this.playerId,s=e.rankings.length;if(e.rankings.length>s||(this.playRemainingMoves(e,i),e.rankings.length>s))return e.rankings[s]===i?1:0;if(e.gameState!=="playing")return 0;e.nextTurn();for(let n=0;n<q.MAX_ROLLOUT_TURNS&&e.gameState==="playing";n++){const a=e.currentPlayerIdx;if(e.throwPhase(),this.playRemainingMoves(e,a),e.rankings.length>s)return e.rankings[s]===i?1:0;e.nextTurn()}return e.rankings.length>s?e.rankings[s]===i?1:0:this.heuristicScore(e)}backpropagate(t,e){for(;t!==null;)t.visits+=1,t.wins+=e,t=t.parent}playRemainingMoves(t,e){for(;t.accumulatedMoves.length>0;){const i=t.getLegalMoves(e);if(i.length===0){t.accumulatedMoves=[];break}const s=i[Math.floor(Math.random()*i.length)],{success:n,captured:a}=t.movePiece(e,s.pieceId,s.steps,s.destination);if(!n){t.accumulatedMoves=[];break}if(a&&t.throwPhase(!0),t.checkWinCondition())break}}heuristicScore(t){const e=t.players[this.playerId].getFinishedPieces().length;let i=e/4,s=0;for(const n of t.players)n.playerId!==this.playerId&&(s=Math.max(s,n.getFinishedPieces().length));return e>s&&(i+=.1),i}};h(q,"MAX_ROLLOUT_TURNS",200);let W=q;class lt{constructor(t=!1){h(this,"game");h(this,"renderer");h(this,"throwAnim");h(this,"controllers",[]);h(this,"controllerTypes",[]);h(this,"phase","setup");h(this,"fast");h(this,"mustLandExactly",!1);h(this,"selectedPieceId",null);h(this,"currentLegalMoves",[]);h(this,"currentThrows",[]);h(this,"setupOverlay");h(this,"gameContainer");h(this,"helpOverlay");h(this,"playerStatus");h(this,"movesList");h(this,"historyLog");h(this,"actionButtons");h(this,"statusMessage");this.fast=t}init(){this.setupOverlay=document.getElementById("setup-overlay"),this.gameContainer=document.getElementById("game-container"),this.helpOverlay=document.getElementById("help-overlay"),this.playerStatus=document.getElementById("player-status"),this.movesList=document.getElementById("moves-list"),this.historyLog=document.getElementById("history-log"),this.actionButtons=document.getElementById("action-buttons"),this.statusMessage=document.getElementById("status-message"),document.getElementById("revision").textContent=`rev ${tt}`,this.setupPlayerConfigUI(),this.setupEventListeners()}setupPlayerConfigUI(){const t=document.getElementById("player-count"),e=document.getElementById("player-configs"),i=nt,s=()=>{const r=Number(t.value);e.innerHTML="";for(let c=0;c<r;c++){const o=document.createElement("div");o.className="player-config",o.style.borderColor=B[c],o.innerHTML=`
          <input type="text" value="${i[c]}" data-player="${c}" class="player-name-input" placeholder="Player ${c+1}" />
          <select data-player="${c}" class="player-type-select">
            <option value="human"${c===0?" selected":""}>Human</option>
            <option value="random"${c>=1&&c<2?" selected":""}>AI (Easy)</option>
            <option value="mc"${c>=2?" selected":""}>AI (Normal)</option>
            <option value="mcts">AlphaYutNori</option>
          </select>
        `;const l=o.querySelector("select");c===0?l.value="human":l.value="random",e.appendChild(o)}};t.addEventListener("change",s),s();const n=document.getElementById("fast-mode");this.fast&&(n.checked=!0);const a=document.getElementById("exact-landing");document.getElementById("start-btn").addEventListener("click",()=>{const r=Number(t.value),c=[];for(let o=0;o<r;o++){const l=e.querySelector(`input[data-player="${o}"]`),u=e.querySelector(`select[data-player="${o}"]`);c.push({name:l.value||`Player ${o}`,type:u.value})}this.fast=n.checked,this.mustLandExactly=a.checked,this.startGame(c)})}setupEventListeners(){document.getElementById("help-btn").addEventListener("click",()=>this.toggleHelp()),document.getElementById("help-close-btn").addEventListener("click",()=>this.toggleHelp()),document.getElementById("settings-btn").addEventListener("click",()=>this.returnToSetup()),document.addEventListener("keydown",t=>this.handleKeydown(t))}handleKeydown(t){if(t.key==="?"){t.preventDefault(),this.toggleHelp();return}if(this.phase==="throwing")(t.key===" "||t.key==="Enter")&&(t.preventDefault(),this.performThrow());else if(this.phase==="selecting_piece"){const i={q:0,w:1,e:2,r:3}[t.key.toLowerCase()];i!==void 0?(t.preventDefault(),this.trySelectPieceById(i)):t.key==="n"||t.key==="N"?(t.preventDefault(),this.tryEnterNewPiece()):t.key==="0"&&(t.preventDefault(),this.skipRemainingMoves())}else if(this.phase==="selecting_move"){t.key==="Escape"&&(t.preventDefault(),this.backToPieceSelection());const i={q:0,w:1,e:2,r:3}[t.key.toLowerCase()];if(i!==void 0){const s=this.actionButtons.querySelectorAll(".btn-move");i<s.length&&(t.preventDefault(),s[i].click())}}}toggleHelp(){this.helpOverlay.classList.toggle("hidden")}returnToSetup(){this.gameContainer.classList.add("hidden"),this.setupOverlay.classList.remove("hidden"),this.phase="setup"}startGame(t){const e=t.map(s=>s.name);this.game=new z(e,t.length,this.mustLandExactly),this.controllers=[],this.controllerTypes=[];for(let s=0;s<t.length;s++)switch(this.controllerTypes.push(t[s].type),t[s].type){case"human":this.controllers.push(new F);break;case"random":this.controllers.push(new ot);break;case"mc":this.controllers.push(new X(this.game,s,100));break;case"mcts":this.controllers.push(new W(this.game,s,1e3));break}this.setupOverlay.classList.add("hidden"),this.gameContainer.classList.remove("hidden");const i=document.getElementById("board-svg");i.innerHTML="",this.renderer=new rt(i),this.throwAnim=new ct,this.renderer.onPieceClick((s,n)=>{this.phase==="selecting_piece"&&s===this.game.currentPlayerIdx&&this.selectPiece(n)}),this.renderer.onNewPieceClick(()=>{this.phase==="selecting_piece"&&this.tryEnterNewPiece()}),this.renderer.onPositionClick(s=>{if(this.phase==="selecting_move"&&this.selectedPieceId!==null){const n=this.getMovesForPiece(this.selectedPieceId).filter(a=>a.destination===s);n.length>0&&this.executeMove(n[0].pieceId,n[0].steps,n[0].destination)}}),this.updateDisplay(),this.startTurn()}async startTurn(){if(this.game.gameState==="finished"){this.showGameOver();return}const t=this.game.getCurrentPlayer(),e=this.controllerTypes[this.game.currentPlayerIdx]==="human";this.phase="throwing",this.updateDisplay(),e?(this.setStatus(`${t.name}'s turn â€” click Throw or press Space`),this.showThrowButton()):(this.setStatus(`${t.name} (AI) is throwing...`),this.clearActions(),await this.delay(300),this.phase="throwing",await this.performThrow())}showThrowButton(){this.actionButtons.innerHTML="";const t=document.createElement("button");t.className="btn btn-primary",t.textContent="Throw (Space)",t.addEventListener("click",()=>this.performThrow()),this.actionButtons.appendChild(t)}async performThrow(){if(this.phase!=="throwing")return;this.phase="animating",this.clearActions();const t=this.game.throwPhase();if(this.currentThrows=t,!this.fast){for(const e of t)await this.throwAnim.animate(e);this.throwAnim.hide()}this.updateDisplay(),await this.startMovePhase()}async startMovePhase(){for(;this.game.accumulatedMoves.length>0;){const t=this.game.currentPlayerIdx,e=this.game.getLegalMoves(t);if(this.currentLegalMoves=e,e.length===0){this.game.accumulatedMoves=[];break}const i=this.controllerTypes[t]==="human";if(i){this.phase="selecting_piece",this.showPieceSelection(e),this.updateDisplay();const n=await this.controllers[t].chooseMove(this.game.getGameState(),e);if(n===null){this.game.accumulatedMoves=[];break}const{captured:a}=this.game.movePiece(t,n.pieceId,n.steps,n.destination);if(this.renderer.clearHighlights(),this.updateDisplay(),await this.delay(300),a&&(this.addHistory("Capture! Bonus throw!",!0),this.fast||await this.renderer.showCaptureEffect(),this.phase="throwing",this.updateDisplay(),this.setStatus(`${this.game.getCurrentPlayer().name} captured â€” bonus throw!`),i?(this.showThrowButton(),await new Promise(r=>{const c=this.performThrow.bind(this);this.performThrow=async()=>{if(this.performThrow=c,this.phase!=="throwing")return;this.phase="animating",this.clearActions();const o=this.game.throwPhase(!0);if(!this.fast){for(const l of o)await this.throwAnim.animate(l);this.throwAnim.hide()}this.updateDisplay(),r()}})):(this.game.throwPhase(!0),this.updateDisplay())),this.game.checkWinCondition()&&(this.updateDisplay(),this.game.gameState==="finished")){this.showGameOver();return}}else{this.phase="animating",this.setStatus(`${this.game.getCurrentPlayer().name} (AI) is thinking...`),this.clearActions();const n=await this.controllers[t].chooseMove(this.game.getGameState(),e);if(n===null){this.game.accumulatedMoves=[];break}await this.delay(300);const{captured:a}=this.game.movePiece(t,n.pieceId,n.steps,n.destination);if(this.updateDisplay(),await this.delay(400),a){this.addHistory("Capture! Bonus throw!",!0),this.fast||await this.renderer.showCaptureEffect();const r=this.game.throwPhase(!0);if(!this.fast){for(const c of r)await this.throwAnim.animate(c);this.throwAnim.hide()}this.updateDisplay()}if(this.game.checkWinCondition()&&(this.updateDisplay(),this.game.gameState==="finished")){this.showGameOver();return}}}if(this.game.gameState==="finished"){this.showGameOver();return}this.game.nextTurn(),this.updateDisplay(),await this.delay(300),this.startTurn()}showPieceSelection(t){const e=this.game.getCurrentPlayer(),i=new Set(t.map(r=>r.pieceId)),s=i.has(-1),n=new Set([...i].filter(r=>r!==-1));if(this.renderer.highlightPieces(e.playerId,n,s),this.actionButtons.innerHTML="",s){const r=document.createElement("button");r.className="btn",r.textContent="New Piece (N)",r.addEventListener("click",()=>this.tryEnterNewPiece()),this.actionButtons.appendChild(r)}const a=document.createElement("button");a.className="btn",a.textContent="Skip (0)",a.addEventListener("click",()=>this.skipRemainingMoves()),this.actionButtons.appendChild(a),this.setStatus(`${e.name}'s turn â€” select a piece (moves: ${this.game.accumulatedMoves.join(", ")})`)}selectPiece(t){this.selectedPieceId=t,this.phase="selecting_move";const e=this.getMovesForPiece(t);this.showMoveSelection(t,e)}getMovesForPiece(t){return this.currentLegalMoves.filter(e=>e.pieceId===t)}showMoveSelection(t,e){const i=this.game.getCurrentPlayer();t===-1||i.getPieceById(t),this.renderer.clearHighlights(),t!==-1&&this.renderer.selectPiece(i.playerId,t);const s=new Map;for(let r=0;r<e.length;r++){const c=H[r]??"";s.has(e[r].destination)||s.set(e[r].destination,c)}this.renderer.highlightDestinations(s),this.actionButtons.innerHTML="";for(let r=0;r<e.length;r++){const c=e[r];let o;c.destination==="EXIT"?o="EXIT":c.destination==="00"?o="GOAL":(o=c.destination,this.game.board.triggersShortcut(c.destination)&&(o+=" (shortcut)"));const l=H[r]??"",u=document.createElement("button");u.className="btn btn-move",u.textContent=`[${l}] ${c.steps} â†’ ${o}`,u.addEventListener("click",()=>this.executeMove(c.pieceId,c.steps,c.destination)),this.actionButtons.appendChild(u)}const n=document.createElement("button");n.className="btn",n.textContent="Back (Esc)",n.addEventListener("click",()=>this.backToPieceSelection()),this.actionButtons.appendChild(n);const a=t===-1?"new piece":`Piece ${H[t]??t}`;this.setStatus(`${i.name} â€” choose move for ${a}`)}executeMove(t,e,i){if(this.phase!=="selecting_move")return;this.phase="animating",this.renderer.clearHighlights(),this.clearActions();const s=this.controllers[this.game.currentPlayerIdx];s instanceof F&&s.submitMove(t,e,i)}trySelectPieceById(t){this.currentLegalMoves.some(i=>i.pieceId===t)&&this.selectPiece(t)}tryEnterNewPiece(){if(this.phase!=="selecting_piece")return;const t=this.currentLegalMoves.filter(e=>e.pieceId===-1);t.length>0&&(this.selectedPieceId=-1,this.phase="selecting_move",this.showMoveSelection(-1,t))}skipRemainingMoves(){if(this.phase!=="selecting_piece")return;this.phase="animating",this.renderer.clearHighlights(),this.clearActions();const t=this.controllers[this.game.currentPlayerIdx];t instanceof F&&t.submitSkip()}backToPieceSelection(){this.phase==="selecting_move"&&(this.selectedPieceId=null,this.phase="selecting_piece",this.renderer.clearHighlights(),this.showPieceSelection(this.currentLegalMoves),this.updateDisplay())}showGameOver(){this.phase="game_over",this.renderer.clearHighlights();const t=this.game.rankings.map(i=>({name:this.game.players[i].name,color:B[i]}));this.renderer.showGameOverEffect(t),this.actionButtons.innerHTML="";const e=document.createElement("button");e.className="btn btn-primary",e.textContent="New Game",e.addEventListener("click",()=>this.returnToSetup()),this.actionButtons.appendChild(e),this.setStatus("")}updateDisplay(){this.updatePlayerStatus(),this.updateMovesDisplay(),this.updateHistory(),this.renderer.updatePieces(this.game.getAllPieces(),this.game.players,this.game.currentPlayerIdx)}updatePlayerStatus(){const t=["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"],e=this.game.rankings,i=this.game.players.length,s=[...this.game.players].sort((a,r)=>{const c=e.indexOf(a.playerId),o=e.indexOf(r.playerId),l=c!==-1;return l!==(o!==-1)?l?1:-1:l?c-o:a.playerId-r.playerId});let n="<h3>Players</h3>";for(const a of s){const r=a.playerId===this.game.currentPlayerIdx,c=B[a.playerId],o=a.getFinishedPieces().length,l=e.indexOf(a.playerId),u=l!==-1,d=l===i-1,p=u&&!d?t[l]??"":"",g=this.controllerTypes[a.playerId],v=g==="human"?"":g==="random"?" (Easy)":g==="mcts"?" (AlphaYutNori)":" (Normal)";n+=`
        <div class="player-status-item ${r?"current":""}" style="${u?"opacity:0.5":""}">
          <span class="player-dot" style="background:${c}"></span>
          <span class="player-name">${p}${p?" ":""}${a.name}${v}</span>
          <span class="player-score">${o}/4</span>
        </div>
      `}this.playerStatus.innerHTML=n}updateMovesDisplay(){const t=this.game.accumulatedMoves;if(t.length===0){this.movesList.textContent="No moves";return}this.movesList.innerHTML=t.map(e=>`<span class="btn btn-small btn-move">${e>0?"+":""}${e}</span>`).join(" ")}updateHistory(){const t=this.game.moveHistory.slice(-15);this.historyLog.innerHTML=t.map(e=>`<div class="history-entry${e.includes("captured")?" capture":""}">${e}</div>`).join(""),this.historyLog.scrollTop=this.historyLog.scrollHeight}addHistory(t,e=!1){const i=document.createElement("div");i.className=`history-entry${e?" capture":""}`,i.textContent=t,this.historyLog.appendChild(i),this.historyLog.scrollTop=this.historyLog.scrollHeight}setStatus(t){this.statusMessage.textContent=t}clearActions(){this.actionButtons.innerHTML=""}delay(t){return this.fast&&(t=Math.min(t,50)),new Promise(e=>setTimeout(e,t))}}const ht=new URLSearchParams(window.location.search).has("fast"),dt=new lt(ht);dt.init();
